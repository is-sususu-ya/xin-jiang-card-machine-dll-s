# 德亚缴费机和云平台对接协议


我们定义缴费机默认状态为ST1，当接受到扫码讯息后，切换为状态ST2，并发送消息或发起请求至后台，根据后台回复内容切换为ST3，其中ST3驻留时间，显示内容等讯息依据回复信息而定。其中ST1一般为欢迎语状态，ST2为扫码等待支付状态，ST3为处理结果状态。

每台设备会定义设备ID号、SSID号，SSID仅可用数字和字母，不可使用中文字符，其中设备ID号为请求时明文参数，SSID号用作签名，签名方式为SSID与时间戳的MD5值，后台以签名判定请求合法性。如SSID为123456，请求时间戳为2020-11-10 12:12:12，则Sign为 MD5(123456&2012-11-10 12:12:12)。

由于服务器在云端，设备与后台云服务没有可用的消息通道，因此后台无法直接向设备端发送消息，所以要么服务器不用下发消息给缴费终端，要么以http短链接或者TCP长连接方式实现消息下发。 下文将定义交互数据协议。

## http短连接模式对接

### 二维码信息上报接口

> 接口地址：http://serverip:port/api/qrcode

> 请求类型：POST

> 设备->后台

**二维码信息上报**

```
{ 
"device_id":"123123", 
"time_stamp":"2020-10-10 12:12:12",
"qrcode":"12312312321313213123",
"sign":"12312312312312321"
}
```

**LED类设备响应**
```
{ 
"type":"led_display",
"timeout":"10000",
"line1":"hello",
"line2":"world",
"line3":"this is test",
"line4":"this is test",
"color":"red",
"sound":"这是一段测试语音",
"vol":"5",
}
```

**LCD类设备响应**
```
{ 
    "type":"lcd_change",
    "timeout":"10000",
    "index":"1", 
    "qrcode":"base64enc data",
    "data":"base64enc data",
    "reserv":"base64enc data",
    "vol":"5",
    "sound":"这是一段测试语音"
}
``` 

**说明**
- vol: 设备音量，1-8可配
- timeout: 切换到此页面的驻留时间，0表示停留在此页面，单位为秒
- index: 表示切换到index个固定页面
- qrcode: 参数为扫码值的Base64编码后的数据（为了防止非出现url中带特殊参数比如"&"，中文等）
- data:  表示切换到某页面的显示内容，使用html文本，实际文本为html数据的base64编码值。
- reserv: 保留字段


### HTTP 消息接口（可选）

> 接口地址：http://serverip:port/api/message

> 请求类型：POST

**说明**

后台设计此消息接口应为阻塞接口，默认超时时间30秒，缴费终端发起http请求后，设置超时时间30秒，这时后台服务需要挂起message接口，当后台有消息需要下发到缴费终端后，立刻通过此接口返回数据。设备端一旦收到消息即可处理，并立刻再次调用此接口。这就实现了通知消息通道。
 
**请求参数**
```
{ 
    "device_id":"123123", 
    "time_stamp":"2020-10-10 12:12:12",
    "sign":"12312312312312321"
}
```
#### 反馈消息

**空闲无消息**
```
{ 
    "type":"idle",
    "time_stamp":"2020-11-10 12:12:12"
} 
```

**LED控制消息**
```
{ 
    "type":"led_display",
    "time_stamp":"2020-11-10 12:12:12",
    "timeout":"10",
    "line1":"hello",
    "line2":"world",
    "line3":"this is test",
    "line4":"this is test",
    "color":"red",
    "sound":"这是一段测试语音"
    "vol":"语音音量1-8"
} 
```

> 说明
- timeout: 表示显示内容的驻留时间，为0时表示一直显示此内容，大于0时表示驻留时间，单位为毫秒，
- Linen: 表示LED几行显示的内容，一般支持2行或者4行显示
- color: 表示显示字符的的颜色
- sound: 表示播报的语音内容
 

**LCD控制消息**

```
{ 
    "type":"lcd_change",
    "time_stamp":"2020-11-10 12:12:12", 
    "timeout":"10",
    "index":"1",
    "qrcode":"base64enc data",
    "data":"base64enc data",
    "reserv":"base64enc data"
    "sound":"语音内容",
    "vol":"语音音量1-8"
}

```

## 长连接模式对接协议

- 帧格式定义

| 字段 | 长度 | 意义                           |
| ---- | ---- | -----------------------|
| STX  | 1    | 0xFF                         |
| LEN  | 4    | 标记后续DATA数据长度，大端模式 |
| DATA | n    | JSON数据，中文GBK编码         |
| CRC  | 1    | DATA字段所有字节的亦或取值     |

> 其中DATA字段为标准Json格式的字符串。此协议兼顾网络与串口协议。

### 设备发向服务器帧信息

#### 登陆帧：设备->后台

> 请求
```
{
    "type":"login"
    "device_id":"123456",
    "key":"12345678"
}
```

> 响应
```
{
    "type":"login",
    "code":"0",
    "msg":"success",
}
```
> device_id、key皆由服务商提供，后台以此字段鉴别登陆设备合法性

#### 心跳帧：设备->后台
> 请求
```
{
    "type":"heartbeat"
}
``` 
> 响应
```
{
    "type":"heartbeat",
    "time_stamp":"2020-11-10 12:12:12"
}
```
- 设备每1分钟上报一次心跳帧，后台收到后需回复心跳帧，心跳帧可用于判定设备连接是否可用，三次未收到心跳回复，设备自动重连

#### 扫码结果：设备->后台
> 请求
```
{
    "type":"qrcode",
    "data":"base64enc data"
}
``` 
> 响应
```
{
    "type":"qrcode",
    "code":"0",
    "msg":"success"
}
```

#### 控制led显示，语音播报：后台->设备
> 请求
```
{
    "type":"led_display",
    "timeout":"10",
    "line1":"hello",
    "line2":"world",
    "line3":"this is test",
    "line4":"this is test",
    "color":"red",
    "sound":"这是一段测试语音",
    "vol":"5",
    "reserv":"保留数据"
}
``` 
> 响应
```
{
    "type":"led_display"
    "code":"0"
    "msg":"success"
}
```
 
#### 切换LCD页面：后台->设备
> 请求
```
{
    "type":"lcd_change",
    "timeout":"10",
    "index":"1",
    "qrcode":"base64code"
    "data":"base64code",
    "sound":"测试语音",
    "vol":"5",
    "reserv":"保留数据"
}
``` 
> 响应
```
{
    "type":"lcd_change"
    "code":"0"
    "msg":"success"
}
```

**页面定义如下**

| 页面编号 | 类型       | 说明                                           |
| -------- | ---------- | ---------------------------------------------- |
| 1-10     | 自定义页面 | 提供10张图片可作为背景图切换，调用方可随意切换 |
| 11       | 交易页面   | data和qrcode有数据即可显示                     |