# **无人值守发卡机动态库使用说明**

 



## 概要

本文介绍了无人值守发卡机的动态库，动态库利回调机制将卡机事件(司机按键、卡取走等)发送给车道程序，车道程序用动态库提供的接口对卡机进行操作。这样方便了车道程序的编写，使得车道程序设计人员把更多的精力放在流程和逻辑方面，而不用费力考虑怎么和卡机进行交互。

## 修改说明

| 修订版本 | 修订日期     | 详细说明   |
| -------- | ------------ | ---------- |
| 1.0.0    | 2021年6月4日 | 第一次发布 |



## 加载方式

加载方式使用dlopen 方式 

### 调用时用到的头文件

``` C

typedef const char*  LPCTSTR;
typedef void * HANDLE;`

typedef void   (*ACMEventHandle)(int a, int b); 
typedef  int  (*_ACM_SetEventCallBackFunc)(ACMEventHandle cb);
typedef  int  (*_ACM_OpenDevice)(const char *devName, int nBaudRate);
typedef  int  (*_ACM_CloseDevice)(void);
typedef  int  (*_ACM_Reject)(void);`
typedef int   (*_ACM_IssueCard)(void);
typedef  int  (*_ACM_RecycleCard)(void);
typedef  int  (*_ACM_SwitchAntenna)(int nPosition);`
typedef  int  (*_ACM_IsOnline)(void);
typedef  int  (*_ACM_ForceEject)(int nChannel);
typedef  int  (*_ACM_ForceRecycle)(int nChannel);`
typedef  int  (*_ACM_GetFirmwareVer)(int  *ver);
typedef  int  (*_ACM_SetBoxSN)(int nChannel, int  dwSN);`
typedef  int  (*_ACM_GetBoxSN)(int nChannel, int  *dwSN);
typedef  int  (*_ACM_SetCardCounter)(int nChannel, int nCount);`
typedef  int  (*_ACM_GetCardCounter)(int nChannel, int *nCount);
typedef  int  (*_ACM_GetChannelState)(int nChannel, int *nState);
typedef  int  (*_ACM_IsBoxLoad)(int nChannel);
typedef int	(*_ACM_GetTxData)(char *buf, int size);
typedef int	(*_ACM_GetRxData)(char *buf, int size);
typedef int   (*_ACM_GetKernelLog)(char *buf, int size);
typedef int   (*_ACM_PlayAudio)(int nIndex);
typedef int   (*_ACM_TriggerButton)(int nChannel);
typedef int   (*_ACM_TextVoice)( int vol, const char *text, int len);
typedef  int  (*_ACM_ClearCardKey)(void);
```

**语音播放说明**

如果已经实现了ACM_TextVoice 有限调用ACM_TextVoice， 如果没有实现，则判断SPM中的语音是否可用， 如果不可用， 最后使用ACM_PlayAudio。

 


# 1. ACM_SetEventMessage

void _stdcall ACM_SetEventMessage(HWND hWnd, UINT MsgNum) 功能：

设置卡机事件接收句柄和消息 ID 参数：

hWnd： 车道程序要接收消息的窗口句柄。

MsgNum：发送的消息编号，动态库向指定窗口发送的消息编号为

MsgNum 返回值：

无说明：

表 1：卡机事件和事件参数

| wParam  （卡机事件编号） | lParam  （事件参数） | 消息含义                                                     |
| ------------------------ | -------------------- | ------------------------------------------------------------ |
| 1                        | 0                    | 卡机核心板复位或上电消息。收到此消息后车道流程也需复位。     |
| 2                        | IsConnect            | 卡机核心板和动态库连接消息。IsConnect 为 1  表示卡机连线，0  代表卡机离线。 |
| 3                        | nChannel             | 按键取卡消息。nChannel（1~4）为对应的通道。                  |
| 4                        | nChannel             | 发卡(从天线位置推出到卡口)成功的消息。nChannel               |

 

|      |          | （1~4）为对应的通道。                                        |
| ---- | -------- | ------------------------------------------------------------ |
| 5    | nChannel | 发卡(从天线位置推出到卡口)失败的消息。nChannel  （1~4）为对应的通道。 |
| 6    | nChannel | 卡口的卡被取走消息。nChannel（1~4）为对应的通道。            |
| 7    | nChannel | 通道状态变化消息。nChannel（1~4）为发生状态变化的通道。收到此消息后，可以通过调用  ACM_GetChannelState  获得通道的状态。 |
| 8    | nChannel | 卡数变化消息。nChannel（1~4）为对应的通道。收到此消息后，可通过调用 ACM_GetCardCounter  获得相应通道卡盒的卡数。 |
| 9    | nChannel | 回收卡成功消息。nChannel（1~4）为对应的通道。                |
| 10   | nChannel | 回收卡失败消息。nChannel（1~4）为对应的通道。                |
| 11   | nDeck    | 军警按键消息。  nDeck：1  为上军警按键，2  为下军警按键      |
| 12   | nChannel | 等待读写通行卡超时消息。nChannel（1~4）为对应的通道。如果按键后，车道软件在一定时间(默认为 15  秒)内没有调用发卡接口或者坏卡回收接口，那么就会收到此消息。收到此消息后再调用发卡接口或者坏卡回收接口将会失败。 |
| 13   | lParam   | 按键忽略消息。此时车道程序不需要启动发卡交易流程。  对于按键被卡机忽略是否进行处理由车道计算机自行决定。参数的 8~16  位为工位号(1  为上工位，2  为下工位)，  0~8  位为忽略代码。  忽略代码对用的含义为：  1.此工位 2  个通道无卡  2.此工位 2  个通道故障  3.此工位 2  个通道故障(未准备好)  4.保留(目前不会出现此忽略代码)  5.按键屏蔽期间  6.连续出现坏卡  车道程序收到此消息后，可以播放合适的提示语音，告知司机，也可以不处理此消息。 |
| 14   | nChannel | 卡盒装上消息。nChannel（1~4）为对应的通道。                  |
| 15   | nChannel | 卡盒卸下消息。nChannel（1~4）为对应的通道。                  |
| 16   | nChannel | 卡盒编号变化消息。nChannel（1~4）为对应的通道。              |
| 22   | nChannel | 卡被从卡口成功拉回                                           |
| 23   | nChannel | 卡被从卡口拉回失败                                           |
| 29   | 0        | 动态库工作线程异常退出消息。                                 |

# 2. ACM_SetEventCallBackFunc

void _stdcall ACM_SetEventCallBackFunc(ACM_EventCallBack cb)

功能：设置卡机事件接收句柄和消息 ID 参数： cb： 卡机事件处理函数指针。

返回值：无说明：

（1）ACM_EventCallBack 定义为：

​             typedef   void( __cdecl * ACM_EventCallBack)(int nEventID, int nEventParam);

（2）卡机事件和事件参数如表 1 所示

# 3. ACM_OpenDevice

BOOL _stdcall ACM_OpenDevice(const char *devName, int nBaudRate)

功能：打开和卡机通信的串口。

参数：  devName  /dev/COM1  ， 如果要加入额外配置， 请用分号分隔并自行解析。 

nBaudRate：为卡机串口的波特率，必须为 9600 或者 19200，默认为 19200

返回值：

TRUE 成功， FALSE 失败说明：

此函数只是打开串口，启动工作线程。至于卡机是否连接成功（有响应上位机的命

令），上位机可以由消息获知（动态库在判断卡机连线或是离线后发送消息给车道程序），或是调用 ACM_IsOnline 接口。

# 4. ACM_CloseDevice

BOOL _stdcall ACM_CloseDevice(void) 功能：

关闭和卡机通信的串口。

参数：无

返回值：

TRUE 成功，FALSE 失败说明：

设备关闭后，动态库工作线程即结束。车道程序不再接收到任何新的消息。

# 5. ACM_IssueCard

BOOL _stdcall ACM_IssueCard(void) 功能：

将工作通道上天线位置的卡推出。

参数：无

返回值：

TRUE 成功，FALSE 失败说明：

工作通道是指卡机在司机按键后选择的通道，因此，出卡不用指定通道，一定只能由工作通道上发卡。

调用此接口返回成功，只表示动态库发送命令成功，卡机出卡成功后会发送出卡成功消息给车道软件。

# 6. ACM_RecycleCard

BOOL _stdcall ACM_RecycleCard(void) 功能：

回收工作通道天线位置的卡参数：无

返回值：

TRUE 成功，FALSE 失败说明：

车道程序在收到司机取卡按键的消息后，开始读写通行卡。当工作通道上的卡读写失败后，调用此接口，让卡机回收工作通道的卡片。调用完此函数成功后，卡机会重新发送按键信息。因此车道程序需等新的按键信息收到后再重新读写新的工作通道上的通行卡，继续发卡流程。

调用此接口返回成功，只表示动态库发送命令成功，卡机回收卡成功后会发送回收卡成功消息给车道软件。

# 7. ACM_Reject

BOOL _stdcall ACM_Reject(void) 功能：

拒绝发卡参数：无

返回值：

TRUE 成功，FALSE 失败说明：

车道程序收到按键消息，判断不符合发卡条件（如没有抓拍讯号、前车尚未离开等）。可以调用此函数，使卡机复位交易流程。所以如果车道程序正在处理按键消息（如正在读写卡片）时，又收到按键消息，不要调用此函数，直接忽略掉即可。

# 8. ACM_SwitchAntenna

BOOL _stdcall ACM_SwitchAntenna(int nPosition) 功能：

切换天线位置到 nPosition 位置。

参数：

nPosition：需为 1~8。其中，1~4 表示 1~4 号通道的通行卡天线位置， 5~8 为 1~4 号通道的卡盒标签卡天线位置（保留）。目前可以接受的值是 1~4。

返回值：

TRUE 成功，FALSE 失败说明：

天线位置在卡机处于等待读写状态下（司机按键一直到车道读写成功或失败）是不允切换的（此时核心板控制逻辑将不理会切换命令）

# 9. ACM_IsOnline

BOOL _stdcall ACM_IsOnline(void) 功能：

获知卡机是否连线参数：无

返回值：

TRUE 卡机连线，FALSE 卡机未连线

# 10. ACM_SwitchChannel

BOOL _stdcall ACM_SwitchChannel(int nChannel) 功能：

切换工作通道。

参数：

nChannel：为 1~4 返回值：

TRUE 成功，FALSE 失败说明：

司机按键时，发卡通道是由核心板程序逻辑决定的。它会先选择当前通道，当前通道不可用时会切换到备用通道。因此，上位机一般是不需要选择通道的。此功能是保留上位机可以在发卡流程开始前先切换通道，发卡流程进行中是不允许切换工作通道的。如果上位机切换到一个不具备发卡条件的通道（例如无卡盒），当司机按键后，核心板会自动切换到具备发卡条件的通道。

上/下工位各有一个工作通道，上工位是 1 或 2，下工位是 3 或 4。切换通道失败的原因只可能是当前发卡流程尚未结束。

# 11.ACM_ForceEject

BOOL _stdcall ACM_ForceEject(int nChannel) 功能：

指定通道强制将备妥在天线位置的卡推出卡机。

参数：

nChannel：为 1~4 返回值：

TRUE 成功，FALSE 失败说明：

正常状况下是不会使用此命令出卡的。卡机为了安全考虑，只有在发出按键信息后才会接受出卡命令（IssueCard）。有些收费系统要求在交接班时候要将卡机里的卡全部清空，此时就使用此命令强制将通道上的卡推出。

# 12. ACM_ForceRecycle

BOOL _stdcall ACM_ForceRecycle(int nChannel) 功能：

强制回收指定通道上的卡（会回收到卡机内的回收盒）参数：

nChannel：为 1~4 返回值：

TRUE 成功，FALSE 失败说明：

此功能也可以用来强制清除所有通道上的卡。

# 13. ACM_GetFirmwareVer

BOOL _stdcall ACM_GetFirmwareVer(DWORD *ver)

功能：获取卡机核心板的软件版本号参数：

*ver：用于存放获取到的软件版本号返回值：

TRUE 成功，FALSE 失败

# 14. ACM_SetBoxSN

BOOL _stdcall ACM_SetBoxSN(int nChannel, DWORD dwSN)

功能：设置指定通道卡盒的 SN。参数：

nChannel：为 1~4

dwSN： 为设置的卡盒序号（不带正负号的 32bit 整数型）。dwSN 不可以是 0，也不可以大于 99999999 (只能是 8 位有效整数) 返回值：

TRUE 成功，FALSE 失败

# 15. ACM_GetBoxSN

BOOL _stdcall ACM_GetBoxSN(int nChannel, DWORD *dwSN)

功能：获取指定通道卡盒的 SN。参数：

nChannel：为 1~4

*dwSN： 用于存放获取到的卡盒 SN 返回值：

TRUE 成功，FALSE 失败

# 16. ACM_SetCardCounter

BOOL _stdcall ACM_SetCardCounter(int nChannel, int nCount)

功能：设置指定通道的卡盒内卡数（不包含天线位置上的卡）。

参数：

nChannel：为 1~4

nCount： 为要设置的卡盒卡数。卡数的上限根据机型或有不同。

返回值：

TRUE 成功，FALSE 失败

# 17. ACM_GetCardCounter

BOOL _stdcall ACM_GetCardCounter(int nChannel, int *nCount)

功能：获取指定通道卡盒的卡数。参数：

nChannel：为 1~4

\* nCount：用于存放获取到的卡盒卡数。此卡数不包含天线位置上的卡。

返回值：

TRUE 成功，FALSE 失败

# 18. ACM_GetChannelState

BOOL _stdcall ACM_GetChannelState(int nChannel, int *nState)

功能：获取指定通道的状态。参数：

nChannel：为 1~4

*nSate： 用于存放获取到的通道状态返回值：

TRUE 成功，FALSE 失败说明：每个 bit 为 1 时代表的意义如下:

Bit0 (0x01): 天线有卡

Bit1 (0x02): 卡口有卡

Bit2 (0x04): 卡取走

Bit3 (0x08): 卡回收

Bit4 (0x10): 天线处有坏卡

Bit5 (0x20): 卡机故障

Bit6 (0x40): 卡机离线

Bit7 (0x80): 没有装入卡盒

# 19. ACM_GetActiveChannel

BOOL _stdcall ACM_GetActiveChannel(int nPosition, int *nActiveChannel)

功能：获取指定工位的当前工作通道参数： nPosition： 1 为上工位，2 为下工位

*nActiveChannel： 0 代表指定工位卡机和核心板离线。1 或 2 为上工位卡机当前工作通道, 3 或 4 为下工位卡机当前工作通道。

返回值：

TRUE 成功，FALSE 失败。

# 20. ACM_IsBoxLoad

BOOL _stdcall ACM_IsBoxLoad(int nChannel)

功能：获取指定通道的卡盒是否装上。参数：

nChannel 为 1~4

返回值：

TRUE 装上，FALSE 卸下

# 21. ACM_GetButtonIgnoreText

BOOL _stdcall ACM_GetButtonIgnoreText (int nCode, char *strReason)

功能：获取按键忽略代码对应的为本信息。

参数：

nCode 为按键忽略代码(卡机动态库发送的消息中，wParam 参数为 8 的是按键忽略消息，参数 lParam 包含按键忽略代码)

*strReason 用于存放获取到的按键忽略原因文本指针。

返回值：

TRUE 成功，FALSE 失败。说明：

(1) 忽略原因代码对应的文本信息：

1："无卡"。

2："故障"。

3："故障"。

4："Unknown" (保留)。

5："按键屏蔽期间"。

6："连续坏卡"。

# 22. ACM_PlayAudio

BOOL _stdcall ACM_PlayAudio (int nIndex)

功能：播放语音。参数：

nIndex 为需要播放的语音索引号。

返回值：

TRUE 成功，FALSE 失败。

说明：

索引号对应的语音内容：

0：“请按键取卡或刷苏通卡”

1：“请取卡”

2：“谢谢合作，请通行”

3：“刷卡成功，请通行”

4：“苏通卡坏，请按键取卡”

5：“卡机故障，请联系工作人员”

6：“对不起，只能执行一次刷卡或取卡操作”

# 23. ACM_TriggerButton

BOOL _stdcall ACM_TriggerButton (int nChannel) 功能：

触发按键（帮助司机按键）。

参数：

nChannel 为需要触发按键的通道号。1~4 表示通道 1~通道 4，5 表示触发上工位按键，6 表示触发下工位按键。

返回值：

TRUE 成功，FALSE 失败。

说明：

此接口的作用是帮助司机按键，以实现提前出卡（司机开车到卡机前时不用手动按键便出卡）的功能。调用此接口后，车道软件会收到按键消息，就像真的有司机按键一样。发卡流程和司机按键时是一样的。

# 24. ACM_PullBackToAnt

BOOL _stdcall ACM_PullBackToAnt(int nChannel) 功能：

将指定通道卡口的卡拉回天线位置。

参数：

nChannel 为通道号（1~4），如果为 0 则将默认通道（即当前的出卡通道）卡口的卡拉回天线位置。返回值：

TRUE 成功，FALSE 失败。

说明：

此接口只对装有回收卡口卡到天线位置装置的机型有效。

## 25    ACM_TextVoice

***BOOL ACM_TextVoice( int vol, const char \*text, int len);\*** 功能：语音合成模块播放文字

n 入参：

u vol： 播放音量，可取 1-8 u Text：播放文字，GBK 编码 u Len: 显示文字的长度

n 返回值：

是否成功


# 25. ACM_PushOutAllCards

BOOL _stdcall ACM_PullBackToAnt(void) 功能：

将所有的卡片推出出卡口外，用于开始回收卡片。 

参数：


说明：

用于实现一键清空卡道内卡片。 