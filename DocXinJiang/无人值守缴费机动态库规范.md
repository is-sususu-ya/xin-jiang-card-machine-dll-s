 

# 无人值守缴费机外设控制接口



## 简述

本文定义了无人值守缴费机的动态库控制接口，动态库利用了 回调机制将卡机事件(司机按键、收卡完成等)发送给车道程序，车道程序用动态库提供的接口对卡机进行操作。

## 修改说明

| 修订版本 | 修订日期       | 详细说明   |
| -------- | -------------- | ---------- |
| 1.0.0    | 2021年10月11日 | 第一次发布 |



## 一、基本要求

加载方式使用dlopen 方式 

```c
typedef void   (*ACCEventHandle)(int a, int b);
typedef  int (*_ACC_SetEventCallBack)(ACCEventHandle cb);
typedef  int (*_ACC_OpenDevice)(const char* devName, int nBaudRate);
typedef  int (*_ACC_CloseDevice)(void);
typedef  int (*_ACC_CollectCard)(void);
typedef  int (*_ACC_RecycleCard)(void);
typedef  int (*_ACC_ReturnCard)(void);
typedef  int (*_ACC_SwitchAntenna)(int nPosition);
typedef  int (*_ACC_IsOnline)(void);
typedef  int (*_ACC_ForceReturn)(int nChannel);
typedef  int (*_ACC_ForceRecycle)(int nChannel);
typedef  int (*_ACC_GetFirmwareVer)(int* ver);
typedef  int (*_ACC_SetBoxSN)(int nChannel, int  dwSN);
typedef  int (*_ACC_GetBoxSN)(int nChannel, int* dwSN);
typedef  int (*_ACC_SetCardCounter)(int nChannel, int nCount);
typedef  int (*_ACC_GetCardCounter)(int nChannel, int* nCount);
typedef  int (*_ACC_GetChannelState)(int nChannel,unsigned int* nState);
typedef  int (*_ACC_IsBoxLoad)(int nChannel);
 
```

**语音播放说明**

如果已经实现了ACC_TextVoice 优先调用ACC_TextVoice ， 如果没有实现， 则调用人机交互中的语音播放方法，出口牵扯到扫码， 必须具备人机交互功能。 。 



## 二、   动态库接口介绍

# 1. ACC_SetEventMessage

void _stdcall ACC_SetEventMessage(HWND hWnd, UINT MsgNum) 功能：

设置卡机事件接收句柄和消息 ID 参数：

hWnd： 车道程序要接收消息的窗口句柄。

MsgNum：发送的消息编号，动态库向指定窗口发送的消息编号为

MsgNum 返回值：

无说明：

动态库发送的消息参数如下表：

| wParam | lParam    | 消息含义                                                     |
| ------ | --------- | ------------------------------------------------------------ |
| 1      | 0         | 卡机核心板复位或上电消息。收到此消息后车道流程也需复位。     |
| 2      | IsConnect | 卡机核心板和动态库连接消息。IsConnect  为 1  表示卡机连线，0  代表卡机离线。 |
| 3      | nChannel  | 按键消息。nChannel（1~4）为对应的通道。                      |
| 4      | nChannel  | 退卡(从天线位置推出到卡口)成功的消息。nChannel  （1~4）为对应的通道。 |
| 5      | nChannel  | 退卡(从天线位置推出到卡口)失败的消息。nChannel  （1~4）为对应的通道。 |
| 6      | nChannel  | 卡口的卡被取走消息。nChannel（1~4）为对应的通道。            |
| 7      | nChannel  | 通道状态变化消息。nChannel（1~4）为发生状态变化的通道。收到此消息后，可以通过调用ACC_GetChannelState  获得通道的状态。 |
| 8      | nChannel  | 卡数变化消息。nChannel（1~4）为对应的通道。收到此消息后，可通过调用 ACC_GetCardCounter  获得相应通道卡盒的卡数。 |
| 9      | nChannel  | 回收卡成功消息。nChannel（1~4）为对应的通道。                |
| 10     | nChannel  | 回收卡失败消息。nChannel（1~4）为对应的通道。                |
| 11     | nDeck     | 军警按键消息。  nDeck：1  为上军警按键，2  为下军警按键      |
| 12     | nChannel  | 等待读写通行卡超时消息。nChannel（1~4）为对应的通道。如果卡被收到天线位置后，车道软件在一定时间(默认为 15  秒)内没有调用收卡接口、退卡接口或者坏卡回收接口，那么就会收到此消息。收到此消息后再调用收卡接口、退卡接口或者坏卡回收接口将会失败。 |
| 13     | lParam    | 保留                                                         |
| 14     | nChannel  | 卡盒装上消息。nChannel（1~4）为对应的通道。                  |
| 15     | nChannel  | 卡盒卸下消息。nChannel（1~4）为对应的通道。                  |
| 16     | nChannel  | 卡盒编号变化消息。nChannel（1~4）为对应的通道。              |
| 20     | nChannel  | 收卡(从天线位置收到到卡盒)成功的消息。nChannel  （1~4）为对应的通道。 |
| 21     | nChannel  | 收卡(从天线位置收到到卡盒)失败的消息。nChannel  （1~4）为对应的通道。 |
| 29     | 0         | 动态库工作线程异常退出消息。                                 |

# 2. ACC_OpenDevice

BOOL _stdcall ACC_OpenDevice(int nCOM, int nBaudRate)

功能：打开和卡机通信的串口。

参数： nCOM： 为和卡机通信的串口号（1 为 COM1，2 为 COM2，以此类推）

nBaudRate：为卡机串口的波特率，必须为 9600 或者 19200，默认为 19200

返回值：

TRUE 成功， FALSE 失败

说明：

此函数只是打开串口，启动工作线程。至于卡机是否连接成功（有响应上位机的命令），上位机可以由消息获知（动态库在判断卡机连线或是离线后发送消息给车道程序），或是调用 ACC_IsOnline 接口。

# 3. ACC_CloseDevice

BOOL _stdcall ACC_CloseDevice(void) 功能：

关闭和卡机通信的串口。

参数：无

返回值：

TRUE 成功，FALSE 失败说明：

设备关闭后，动态库工作线程即结束。车道程序不再接收到任何新的消息。

# 4. ACC_CollectCard

BOOL _stdcall ACC_CollectCard(void) 功能：

将工作通道上天线位置的卡收到卡盒。

参数：无

返回值：

TRUE 成功，FALSE 失败说明：

工作通道是指司机将卡插入的通道，因此，收卡不用指定通道，一定只能由工作通道上收卡。

调用此接口返回成功，只表示动态库发送命令成功，卡机收卡成功后会发送收卡成功消息给车道软件。

# 5. ACC_RecycleCard

BOOL _stdcall ACC_RecycleCard(void) 功能：

回收工作通道天线位置的卡参数：无

返回值：

TRUE 成功，FALSE 失败说明：

车道程序在收到司机取卡按键的消息后，开始读写通行卡，当判断需要将卡回收到坏卡回收盒时，调用此接口，让卡机回收工作通道的卡片。

调用此接口返回成功，只表示动态库发送命令成功，卡机回收卡成功后会发送回收卡成功消息给车道软件。

# 6. ACC_ReturnCard

BOOL _stdcall ACC_ReturnCard(void) 功能：退卡参数：无

返回值：

TRUE 成功，FALSE 失败说明：

车道程序收到按键消息，判断不符合收卡条件（如没有抓拍讯号、前车尚未离开等）。可以调用此函数，使卡机复位交易流程。所以如果车道程序正在处理按键消息（如正在读写卡片）时，又收到按键消息，不要调用此函数，直接忽略掉即可。调用此接口后，卡机会将天线位置的卡退到卡口。

# 7. ACC_SwitchAntenna

BOOL _stdcall ACC_SwitchAntenna(int nPosition)

功能：

切换天线位置到 nPosition 位置。

参数：

nPosition：需为 1~8。其中，1~4 表示 1~4 号通道的通行卡天线位置， 5~8 为 1~4 号通道的卡盒标签卡天线位置（保留）。目前可以接受的值是 1~4。

返回值：

TRUE 成功，FALSE 失败说明：

天线位置在卡机处于等待读写状态下（司机按键一直到车道读写成功或失败）是不

允切换的（此时核心板控制逻辑将不理会切换命令），此接口一般用在调试时使用。

# 8. ACC_IsOnline

BOOL _stdcall ACC_IsOnline(void)

功能：获知卡机是否连线参数：无返回值：

TRUE 卡机连线，FALSE 卡机未连线

# 9. ACC_ForceReturn

BOOL _stdcall ACC_ForceReturn(int nChannel)

功能：指定通道强制将备妥在天线位置的卡退到卡机口。

参数：

nChannel：为 1~4

返回值：

TRUE 成功，FALSE 失败说明：

正常状况下不会使用此命令退卡。卡机为了安全考虑，只有在发出按键信息后才会

接受收卡命令（CollectCard）。有些特殊使用的场合，比如没有设置读写超时的情况下，司机将卡插入卡口后，如果没有收到命令，那么卡一直会在天线位置，此时可以调用此接口将卡退到卡口。

# 10. ACC_ForceRecycle

BOOL _stdcall ACC_ForceRecycle(int nChannel)

功能：强制回收指定通道上的卡（会回收到卡机内的回收盒）参数：

nChannel：为 1~4

返回值：

TRUE 成功，FALSE 失败

# 11.ACC_GetFirmwareVer

BOOL _stdcall ACC_GetFirmwareVer(DWORD *ver)

功能：获取卡机核心板的软件版本号参数：

*ver：用于存放获取到的软件版本号返回值：

TRUE 成功，FALSE 失败

# 12. ACC_SetBoxSN

BOOL _stdcall ACC_SetBoxSN(int nChannel, DWORD dwSN)

功能：设置指定通道卡盒的 SN。参数：

nChannel：为 1~4

dwSN： 为设置的卡盒序号（不带正负号的 32bit 整数型）。dwSN 不可以是 0，也不可以大于 99999999 (只能是 8 位有效整数) 返回值：

TRUE 成功，FALSE 失败

# 13. ACC_GetBoxSN

BOOL _stdcall ACC_GetBoxSN(int nChannel, DWORD *dwSN)

功能：获取指定通道卡盒的 SN。参数：

nChannel：为 1~4

*dwSN： 用于存放获取到的卡盒 SN 返回值：

TRUE 成功，FALSE 失败

# 14. ACC_SetCardCounter

BOOL _stdcall ACC_SetCardCounter(int nChannel, int nCount)

功能：设置指定通道的卡盒内卡数（不包含天线位置上的卡）。

参数：

nChannel：为 1~4

nCount： 为要设置的卡盒卡数。卡数的上限根据机型或有不同。

返回值：

TRUE 成功，FALSE 失败

# 15. ACC_GetCardCounter

BOOL _stdcall ACC_GetCardCounter(int nChannel, int *nCount)

功能：获取指定通道卡盒的卡数。参数：

nChannel：为 1~4

\* nCount：用于存放获取到的卡盒卡数。此卡数不包含天线位置上的卡。

返回值：

TRUE 成功，FALSE 失败

# 16. ACC_GetChannelState

BOOL _stdcall ACC_GetChannelState(int nChannel, int *nState)

功能：获取指定通道的状态。参数：

nChannel：为 1~4

*nSate： 用于存放获取到的通道状态返回值：

TRUE 成功，FALSE 失败说明：

每个 bit 为 1 时代表的意义如下:

Bit0 (0x01): 天线有卡

Bit1 (0x02): 卡口有卡

Bit2 (0x04): 卡取走

Bit3 (0x08): 卡回收

Bit4 (0x10): 天线处有坏卡

Bit5 (0x20): 卡机故障

Bit6 (0x40): 卡机离线 Bit7 (0x80): 没有装入卡盒

# 17. ACC_IsBoxLoad

BOOL  ACC_IsBoxLoad(int nChannel)

功能：获取指定通道的卡盒是否装上。参数：

nChannel 为 1~4

返回值：

TRUE 装上，FALSE 卸下

## 18    ACC_TextVoice

***BOOL ACC_TextVoice( int vol, const char \*text, int len);\*** 功能：语音合成模块播放文字

n 入参：

u vol： 播放音量，可取 1-8 u Text：播放文字，GBK 编码 u Len: 显示文字的长度

n 返回值：

是否成功