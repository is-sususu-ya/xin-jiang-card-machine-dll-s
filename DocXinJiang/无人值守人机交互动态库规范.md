# 无人值守人机交互动态库规范

 

## **1** 说明

 无人值守人机交互动态库用于控制入口发卡机和出口缴费机的只能语音合成、屏幕显示LED 、二维码识别 



## 1.1      接口定义

表 1：动态库接口列表

|      | SPM_Create            | 创建缴费机对象                 |      |
| ---- | --------------------- | ------------------------------ | ---- |
|      | SPM_Destory           | 销毁缴费机对象                 |      |
|      | SPM_IsOnline          | 缴费机是否在线                 |      |
|      | SPM_Open              | 打开缴费机                     |      |
|      | SPM_Close             | 关闭缴费机                     |      |
|      | SPM_SetCallBack       | 设置回调函数                   |      |
|      | SPM_Voice_SendText    | 语音模组播放合成文字           |      |
|      | SPM_InitPhone         | 初始化SIP客户端                |      |
|      | SPM_CallPhone         | 呼叫                           |      |
|      | SPM_AnswerPhone       | 应答                           |      |
|      | SPM_Lcd_ChangeContext | LCD 模组切换场景               |      |
|      | SPM_SyncTime          | 缴费机同步时间                 |      |
|      | SPM_Reboot            | 缴费机重启                     |      |
|      | SPM_EnableQrCode      | 缴费机使能 QR 上报（默认使能） |      |
|      | SPM_GpioOutPut        |    控制io                      |      |
|      | SPM_GetQrCodeEx       | 获取扫码讯息以及扫码工位       |      |
|      | SPM_ReadDi            | 读取                           |      |


## 1.2      事件列表

| 事件号 |              |
| ------ | ------------ |
| 1      | 设备上线     |
| 2      | 设备离线     |
| 3      | 有识别二维码 |
| 4      | IO 输入变化  |

接口定义:

```c
typedef void(*SPM_CallBack)(HANDLE h, int code);

typedef  HANDLE  (*_SPM_Create)(void);
typedef  int  (*_SPM_Destory)(HANDLE h);
typedef  int  (*_SPM_IsOnline)(HANDLE h);
typedef  int  (*_SPM_Open)(HANDLE h, const char *devName); 
typedef  int  (*_SPM_Close)(HANDLE h);  
typedef  int  (*_SPM_SetCallBack)(HANDLE h, SPM_CallBack);
typedef  int  (*_SPM_Voice_SendText)(HANDLE h, int vol, const char *text, int len);
typedef  int  (*_SPM_Lcd_ChangeContext)(HANDLE h, int index, const char *text, int len);
typedef  int  (*_SPM_SyncTime)(HANDLE h);
typedef  int  (*_SPM_Reboot)(HANDLE h);
typedef  int  (*_SPM_EnableQrCode)(HANDLE h, int en);
typedef  int  (*_SPM_GpioOutPut)(HANDLE h, int pin, int val);
typedef  int  (*_SPM_GetQrCodeEx)(HANDLE h, int* index, char* buf); 
typedef int   (*_SPM_GetEnvInfo)(int* temperature, int* humidity);
typedef int   (*_SPM_InitPhone)(HANDLE h, char* server, int port, char* phoneId, char* password);
typedef int   (*_SPM_AnswerPhone)(HANDLE h, char* phoneId, int reply, int timeout);
typedef int   (*_SPM_CallPhone)(HANDLE h, char* phoneId, int timeout);
```



# 2           函数说明

所有接口的导出类型为 StdCall

## 2.1      SPM_Create

***HANDLE SPM_Create();\***

功能：创建缴费机对象

n  入参：无

n  返回值：

对象指针，若创建失败，返回空指针 NULL

n  说明：

创建成功后返回对象指针，后续的接口操作需要该对象

指针

## 2.2      SPM_Destory

***BOOL SPM_Destory(HANDLE h);\*** 

功能：销毁缴费机对象

n 入参：

u h：SPM_Create 接口返回的缴费机对象，下同

n 返回值：是否成功

## 2.3      SPM_IsOnline

***EXPAPI BOOL CALLTYPE SPM_IsOnline(HANDLE h);\***

功能：缴费机是否在线

n 入参：

u h：缴费机对象

n 返回值：是否在线

## 2.4      SPM_Open

***BOOL SPM_Open(HANDLE h, const char \*devName);\*** 

功能：打开缴费机设备，创建工作线程

n 入参：

u h：缴费机对象

u devName： 设备名，串口如“COM1” linux 下如

### “/dev/ttyAMA1”

n 返回值：是否成功

## 2.5      SPM_Close

***BOOL SPM_Close(HANDLE h);\***

功能：关闭缴费机设备，销毁工作线程

n 入参：

### u h：缴费机对象

n 返回值：

是否成功



## 2.7      SPM_SetCallBack

***BOOL SPM_SetCallBack(HANDLE h, SPM_CallBack fxc);\***

***Typedef void (\* __stdcall SPM_CallBack)(HANDLE h, int code);\*** 

功能：设置回调函数

n  入参：

u h：缴费机对象

u fxc: 回调处理函数

n  返回值：

是否成功



## 2.8    SPM_Voice_SendText

***BOOL SPM_Voice_SendText(HANDLE h, int vol, const char \*text, int len);\*** 

功能：语音合成模块播放文字

n 入参：

u h：缴费机对象 u vol： 播放音量，可取 1-8 u Text：播放文字，GBK 编码 u Len: 显示文字的长度

n 返回值：

是否成功

## 2.9    SPM_Lcd_ChangeContext

***BOOL SPM_Lcd_ChangeContext(HANDLE h, int index, const char \*text, int len);\*** 

功能：LCD 屏幕切换场景

n 入参：

u h：缴费机对象 u index：场景编号，目前支持 1-4 u Text：对应场景下的文字讯息 u Len: 文字讯息长度

n 返回值：

是否成功

## 2.10    SPM_SyncTime

***BOOL SPM_SyncTime(HANDLE h);\*** 功能：缴费机系统对时

n  入参：

u h：缴费机对象

n  返回值：

是否成功

## 2.11    SPM_Reboot

***BOOL SPM_Reboot(HANDLE h);\*** 功能：缴费机系统重启

n  入参：

u h：缴费机对象

n  返回值：

是否成功

## 2.12    SPM_EnableQrCode

***BOOL SPM_EnableQrCode(HANDLE h, BOOL en);\*** 

功能：缴费机使能二维码上报

n  入参：

u h：缴费机对象

u en: 使能参数，0 位禁用，1 为使能

n  返回值：

是否成功

## 2.13    SPM_GetQrCode

***BOOL SPM_GetQrCode(HANDLE h, char \*buf);\***

功能：获取扫描二维码值，在发生二维码生成事件号后，调用此接口获取二维码值。

n 入参：

u h：缴费机对象 u buf: 保存二维码的缓存，函数返回时，二维码保存在此 buf 中

n 返回值：

是否成功


## 2.13.1     SPM_GetQrCodeEx

***BOOL SPM_GetQrCodeEx(HANDLE h, int* index, char \*buf);\**

功能：获取扫描二维码值，在发生二维码生成事件号后，调用此接口获取二维码值。

n 入参：

u h：缴费机对象 u buf: 保存二维码的缓存，函数返回时，二维码保存在此 buf 中  扫码设备的工位信息 通过index传出 

n 返回值：

是否成功


## 2.14    SPM_GpioOutPut

**typedef  int  SPM_GpioOutPut(HANDLE h, int pin, int val);**

功能： 

设置伸缩臂状态，PIN  0 ,  Val  0 收回， 1 伸出 。

发票回收    PIN 2 ， Val  1 

发票推出   PIN  2 , Val  0 

n 返回值：

是否成功

## 2.15    SPM_ReadDi

***  SPM_ReadDi(HANDLE h, int* parma)\***

功能： 读取输入

n 入参：

u h：缴费机对象 

 parma  4字节 int值

 1 & 1     发卡机上工位按钮

 2 & 1   下工位发卡机

 3 & 1   求助按钮
 
 4 & 1   求助按钮



n 返回值：

是否成功


## 2.16 SPM_InitPhone

***BOOL SPM_InitPhone(HANDLE h, char* server,int port, char* phoneId,char* password);

n 入参：

u h：缴费机对象

  server： 初始化实时通讯时用到的服务器地址，

  port: 5060 sip服务器端口号
  phoneId 号码
  password 密码


n 返回值：是否成功


## 2.17    SPM_CallPhone 

*** int  SPM_CallPhone(HANDLE h,int index, char* phoneId, int timeout);

功能： 呼叫客服中心客服

n 入参：

u h：缴费机对象 
index  上下工位
 phoneId 字符串   客服的ID号码
 timeout  字符串   超时时间 超过指定时间， 则放弃呼叫。 

n 返回值：

是否成功 这里返回成功则是 对方已经开始振铃， 算成功。 是否接听， 

注意:  对方接听后， onSPMEvent  中 code 为 100 ， 对方拒接， 返回 101。 通话过程中对方挂机， 102 ， 中途异常， 103 ， 



## 2.18    SPM_AnswerPhone  

SPM_AnswerPhone(HANDLE h,int index, char* phoneId, int reply, int timeout);

功能：  当通过onSPMEvent收到 200 时 ， 说明中心有呼叫， 使用SPM_AnswerWaiter进行回复。 

n 入参：

u h：缴费机对象 

    phoneId  字符串   客服的ID号码
   timeout   数字    超过指定时间则放弃， 可能是因为网络通讯扥个问题。 

reply  数字   100 ， 接听， 101 ， 挂机。 


n 返回值：

是否成功  这里返回成功是指通讯已经建立 

注意: 应答成功后 onSPMEvent  中 code 为 100 ，对方已经挂机 101，   通话过程中对方挂机， 102 ， 中途异常， 103，


## 2.19    SPM_GetEnvInfo

 int  SPM_GetEnvInfo(HANDLE h,int* temperature, int* humidity);

功能：  读取温度和湿度

n 入参：

u h：缴费机对象 
  temperature   一个整数的指针  比如 36.5 度   这里返回 3650 
  humidity   一个整数的指针  比如 70.21   这里返回 7021 


n 返回值：

是否成功  
 